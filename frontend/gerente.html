<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Panel del Gerente</title>
  </head>
  <body>
    <h2>Panel de Gestión – Gerente</h2>

    <div class="seccion">
      <h2>➕ Registrar nuevo consultorio</h2>
      <form id="formConsultorio">
        <input
          type="text"
          id="nombreConsultorio"
          placeholder="Nombre del consultorio"
          required
        />
        <button type="submit">Agregar Consultorio</button>
      </form>
      <ul id="listaConsultorios"></ul>
    </div>

    <section>
      <h3>➕ Registrar nuevo doctor</h3>
      <form id="formDoctor">
        <input type="text" id="userDoctor" placeholder="Usuario" required />
        <input
          type="password"
          id="passDoctor"
          placeholder="Contraseña"
          required
        />
        <button type="submit">Registrar Doctor</button>
      </form>
      <ul id="listaDoctores"></ul>
    </section>

    <script>
      async function registrarConsultorio() {
        await fetch("/api/consultorios", { method: "POST" });
        cargarConsultorios();
      }

      async function cargarConsultorios() {
        try {
          const res = await fetch("/api/consultorios");
          const consultorios = await res.json();
          const ul = document.getElementById("listaConsultorios");
          ul.innerHTML = "";

          consultorios.forEach((c) => {
            const li = document.createElement("li");
            const nombre = c.nombre || `Consultorio ${c.id}`;
            li.textContent = `#${c.id} – ${nombre} (${
              c.ocupado ? "Ocupado" : "Libre"
            })`;

            const btnEliminar = document.createElement("button");
            btnEliminar.textContent = "Eliminar";
            btnEliminar.style.marginLeft = "10px";
            btnEliminar.onclick = () => eliminarConsultorio(c.id);

            li.appendChild(btnEliminar);
            ul.appendChild(li);
          });
        } catch (error) {
          console.error("Error cargando consultorios:", error);
        }
      }

      async function eliminarConsultorio(id) {
        const confirmar = confirm(
          "¿Seguro que deseas eliminar este consultorio?"
        );
        if (!confirmar) return;

        const res = await fetch(`/api/consultorios/${id}`, {
          method: "DELETE",
        });

        if (res.ok) {
          cargarConsultorios();
        } else {
          alert("Error al eliminar consultorio");
        }
      }

      document
        .getElementById("formConsultorio")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const nombre = document.getElementById("nombreConsultorio").value;

          await fetch("/api/consultorios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre }),
          });

          document.getElementById("formConsultorio").reset();
          cargarConsultorios();
        });

      cargarConsultorios();

      document
        .getElementById("formDoctor")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const usuario = document.getElementById("userDoctor").value;
          const clave = document.getElementById("passDoctor").value;
          await fetch("/api/usuarios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usuario, clave, rol: "doctor" }),
          });
          document.getElementById("formDoctor").reset();
          cargarDoctores();
        });

      async function cargarDoctores() {
        const res = await fetch("/api/usuarios");
        const usuarios = await res.json();
        const doctores = usuarios.filter((u) => u.rol === "doctor");
        const ul = document.getElementById("listaDoctores");
        ul.innerHTML = "";
        doctores.forEach((doc) => {
          const li = document.createElement("li");
          li.textContent = doc.usuario;
          ul.appendChild(li);
        });
      }

      cargarConsultorios();
      cargarDoctores();
    </script>
  </body>
</html>
